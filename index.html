<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
  <title>CubeHouse Pro | Advanced Timer</title>
  <style>
    :root {
      --accent: #00ffa3;
      --bg-dark: #0b0e11;
      --card-bg: rgba(255, 255, 255, 0.05);
      --text: #ffffff;
      --danger: #ff4b4b;
      --algo-color: #ffcc00;
      --panel-bg: #1a1d21;
    }

    body {
      font-family: 'Inter', sans-serif;
      margin: 0; padding: 0;
      background-color: var(--bg-dark);
      color: var(--text);
      min-height: 100vh;
      display: flex; flex-direction: column; align-items: center;
      overflow-x: hidden;
    }

    .logo-header {
      margin-top: 30px;
      text-align: center;
    }
    .neon-text {
      font-size: 2.5rem;
      font-weight: 900;
      letter-spacing: 5px;
      text-transform: uppercase;
      color: #fff;
      text-shadow: 0 0 10px var(--accent), 0 0 20px var(--accent);
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; text-shadow: 0 0 20px var(--accent), 0 0 40px var(--accent); }
    }

    header { width: 100%; text-align: center; padding: 10px; }
    
    #scramble-display {
      font-family: 'JetBrains Mono', monospace;
      font-size: 1.1rem;
      background: var(--card-bg);
      padding: 18px;
      border-radius: 12px;
      margin: 10px auto;
      color: var(--accent);
      border: 1px solid rgba(255,255,255,0.1);
      width: 85%;
      max-width: 800px;
    }

    .main-layout {
      display: grid;
      grid-template-columns: 1fr 380px; 
      gap: 20px;
      width: 95%;
      max-width: 1300px;
      margin-bottom: 40px;
    }

    @media (max-width: 950px) {
      .main-layout { grid-template-columns: 1fr; }
      #timer { font-size: 70px !important; }
    }

    .tutorial-pane {
      background: var(--panel-bg);
      padding: 20px;
      border-radius: 20px;
      height: 75vh;
      overflow-y: auto;
      border: 1px solid rgba(255,255,255,0.1);
    }
    .tutorial-pane h3 { color: var(--accent); text-align: center; border-bottom: 2px solid var(--accent); padding-bottom: 10px; }

    .step-card {
      background: rgba(255,255,255,0.03);
      padding: 15px;
      border-radius: 12px;
      margin-bottom: 15px;
      border-left: 3px solid var(--accent);
    }
    .algo-box { background: #000; padding: 8px; border-radius: 6px; color: var(--algo-color); font-family: monospace; text-align: center; margin-top: 8px; }

    .data-pane { display: flex; flex-direction: column; gap: 20px; }
    
    .timer-card {
      background: var(--card-bg);
      padding: 60px 20px;
      border-radius: 24px;
      text-align: center;
      cursor: pointer;
      user-select: none;
      touch-action: none;
      transition: 0.2s;
    }
    #timer { font-size: 90px; font-weight: 800; font-family: monospace; }
    .timer-card.inspection { color: #ffae00; }
    .timer-card.holding { color: var(--danger); }
    .timer-card.ready { color: var(--accent); text-shadow: 0 0 15px var(--accent); }

    .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
    .stat-tile { background: var(--card-bg); padding: 12px; border-radius: 10px; text-align: center; }
    .stat-label { font-size: 0.6rem; opacity: 0.5; }
    .stat-val { font-size: 1.1rem; font-weight: bold; color: var(--accent); }

    .solve-store {
      background: var(--panel-bg);
      border-radius: 18px;
      padding: 15px;
      border: 1px solid rgba(255,255,255,0.1);
    }
    .history-list { max-height: 140px; overflow-y: auto; margin-bottom: 10px; }
    .history-item { display: flex; justify-content: space-between; padding: 8px; background: rgba(255,255,255,0.02); border-radius: 6px; margin-bottom: 5px; font-size: 0.8rem; }

    .action-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .btn { background: none; border: 1px solid var(--accent); color: var(--accent); padding: 8px; border-radius: 6px; cursor: pointer; font-size: 0.75rem; font-weight: bold; transition: 0.3s; }
    .btn:hover { background: var(--accent); color: #000; }
    .btn-danger { border-color: var(--danger); color: var(--danger); }
    .btn-danger:hover { background: var(--danger); color: #fff; }

    footer { padding: 20px; opacity: 0.3; font-size: 0.7rem; text-align: center; }
  </style>
</head>
<body>

  <div class="logo-header">
    <div class="neon-text">CUBEHOUSE</div>
  </div>

  <header>
    <div id="scramble-display">Generating Scramble...</div>
    <div style="font-size: 0.7rem; opacity: 0.4; margin-top: 5px;">(I) INSPECTION: 15s</div>
  </header>

  <div class="main-layout">
    <div class="data-pane">
      <div class="timer-card" id="timer-trigger">
        <div id="timer">0.00</div>
        <div id="status-hint" style="opacity: 0.4; font-size: 0.7rem; margin-top: 10px;">PRESS TO INSPECT</div>
      </div>

      <div class="stats-grid">
        <div class="stat-tile"><div class="stat-label">PB</div><div class="stat-val" id="pb-display">--</div></div>
        <div class="stat-tile"><div class="stat-label">AVG 5</div><div class="stat-val" id="avg-display">--</div></div>
        <div class="stat-tile"><div class="stat-label">TOTAL</div><div class="stat-val" id="count-display">0</div></div>
      </div>

      <div class="solve-store">
        <div class="history-list" id="history-list"></div>
        <div class="action-row">
          <button class="btn" onclick="exportData()">EXPORT CSV</button>
          <button class="btn btn-danger" onclick="resetStore()">WIPE ALL</button>
        </div>
      </div>

      <div class="shop-section" style="background: var(--card-bg); padding: 15px; border-radius: 15px; text-align: center;">
        <span style="font-size: 0.7rem; font-weight: bold; color: var(--accent);">RECOMMENDED SHOPS</span>
        <div style="display: flex; justify-content: center; gap: 20px; margin-top: 10px;">
          <a href="https://linktr.ee/oxlrubiks" style="text-decoration:none; color:#fff; font-size:0.7rem;">Arab World</a>
          <a href="https://speedcubeshop.com/" style="text-decoration:none; color:#fff; font-size:0.7rem;">Global</a>
        </div>
      </div>
    </div>

    <div class="tutorial-pane">
      <h3>LEARNING HUB</h3>
      <div class="step-card">
        <span style="color:var(--accent); font-weight:bold;">1. WHITE CROSS</span>
        <p style="font-size:0.85rem;">Daisy on Yellow center → Match sides → Flip 180°.</p>
      </div>
      <div class="step-card">
        <span style="color:var(--accent); font-weight:bold;">2. FIRST LAYER</span>
        <div class="algo-box">R' D' R D</div>
      </div>
      <div class="step-card">
        <span style="color:var(--accent); font-weight:bold;">3. SECOND LAYER</span>
        <p style="font-size:0.8rem;">Right: U R U' R' U' F' U F<br>Left: U' L' U L U F U' F'</p>
      </div>
      <div class="step-card">
        <span style="color:var(--accent); font-weight:bold;">4. YELLOW CROSS</span>
        <div class="algo-box">F R U R' U' F'</div>
      </div>
      <div class="step-card">
        <span style="color:var(--accent); font-weight:bold;">5. OLL (YELLOW TOP)</span>
        <div class="algo-box">R U R' U R U2 R'</div>
      </div>
      <div class="step-card">
        <span style="color:var(--accent); font-weight:bold;">6. CORNER PERMUTATION</span>
        <div class="algo-box">R' F R' B2 R F' R' B2 R2</div>
      </div>
      <div class="step-card">
        <span style="color:var(--accent); font-weight:bold;">7. FINAL EDGE CYCLE</span>
        <div class="algo-box">F2 U L R' F2 L' R U F2</div>
      </div>
    </div>
  </div>
  
  <h6>if you want to learn the cube by a video click <a href="https://www.youtube.com/channel/UCTmgbsO_niVSKeqzkD3FrHg" target="_blank">here</a></h6>
  <footer>CUBEHOUSE PRO v4.0 • 2025</footer>

  <script>
    const timerEl = document.getElementById('timer');
    const trigger = document.getElementById('timer-trigger');
    const scrambleEl = document.getElementById('scramble-display');
    const hintEl = document.getElementById('status-hint');
    
    let startTime, interval, inspectInterval;
    let running = false, ready = false, inspecting = false;
    let waitingForInspection = true; // NEW: Logic gate for idle state
    let holdTimeout;
    let history = JSON.parse(localStorage.getItem('cubehouse_pro_v4')) || [];

    function formatTime(ms) { return (ms / 1000).toFixed(2); }

    function generateScramble() {
      const moves = ["U", "D", "L", "R", "F", "B"], mods = ["", "'", "2"];
      let s = [], last = "";
      for(let i=0; i<20; i++){
        let m = moves[Math.floor(Math.random()*6)];
        while(m === last) m = moves[Math.floor(Math.random()*6)];
        s.push(m + mods[Math.floor(Math.random()*3)]);
        last = m;
      }
      scrambleEl.innerText = s.join(" ");
    }

    function updateUI() {
      const times = history.map(s => s.time);
      document.getElementById('pb-display').innerText = times.length ? formatTime(Math.min(...times)) : "--";
      document.getElementById('count-display').innerText = history.length;
      
      if(times.length >= 5) {
        const last5 = times.slice(0, 5);
        const avg = last5.reduce((a,b)=>a+b, 0) / 5;
        document.getElementById('avg-display').innerText = formatTime(avg);
      } else {
        document.getElementById('avg-display').innerText = "--";
      }
      
      document.getElementById('history-list').innerHTML = history.slice(0, 8).map((s, idx) => `
        <div class="history-item"><span style="opacity:0.4">#${history.length - idx}</span><span style="color:var(--accent); font-weight:bold;">${formatTime(s.time)}s</span></div>
      `).join('');
    }

    function handleStart() {
      if (running) {
        stopTimer();
      } else if (waitingForInspection) {
        // First click after a solve or at start: Begin 15s inspection
        startInspection();
      } else if (inspecting) {
        // During inspection: Hold to prepare the actual timer
        startHolding();
      }
    }

    function handleEnd() {
      clearTimeout(holdTimeout);
      if (ready && !running) {
        startTimer();
      }
      ready = false;
      trigger.classList.remove('holding', 'ready');
    }

    function startInspection() {
      waitingForInspection = false;
      inspecting = true;
      let count = 15;
      timerEl.innerText = count;
      trigger.classList.add('inspection');
      hintEl.innerText = "INSPECTING - HOLD TO READY";
      
      inspectInterval = setInterval(() => {
        count--;
        timerEl.innerText = count;
        if(count <= 0) {
          clearInterval(inspectInterval);
          startTimer(); 
        }
      }, 1000);
    }

    function startHolding() {
      trigger.classList.add('holding');
      hintEl.innerText = "HOLDING...";
      holdTimeout = setTimeout(() => {
        ready = true;
        trigger.classList.replace('holding', 'ready');
        hintEl.innerText = "RELEASE TO START";
      }, 300);
    }

    function startTimer() {
      clearInterval(inspectInterval);
      inspecting = false;
      running = true;
      trigger.classList.remove('inspection', 'holding', 'ready');
      hintEl.innerText = "SOLVING...";
      startTime = Date.now();
      interval = setInterval(() => {
        timerEl.innerText = formatTime(Date.now() - startTime);
      }, 10);
    }

    function stopTimer() {
      clearInterval(interval);
      running = false;
      waitingForInspection = true; // Wait for user to trigger next inspection
      hintEl.innerText = "PRESS TO INSPECT";
      
      history.unshift({ time: Date.now() - startTime, date: new Date().toLocaleDateString() });
      localStorage.setItem('cubehouse_pro_v4', JSON.stringify(history));
      updateUI();
      generateScramble();
    }

    function exportData() {
      let csv = "Solve #,Time(s),Date\n";
      history.forEach((s, i) => { csv += `${history.length - i},${formatTime(s.time)},${s.date}\n`; });
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.setAttribute('href', url);
      a.setAttribute('download', 'cubehouse_session.csv');
      a.click();
    }

    function resetStore() {
      if(confirm("Erase all solve history?")) { 
        history = []; 
        localStorage.removeItem('cubehouse_pro_v4'); 
        timerEl.innerText="0.00"; 
        waitingForInspection = true;
        hintEl.innerText = "PRESS TO INSPECT";
        updateUI(); 
      }
    }

    // Input Listeners
    window.addEventListener('keydown', (e) => { 
      if(e.code === 'Space') { 
        e.preventDefault(); 
        if(!e.repeat) handleStart(); 
      } 
    });
    window.addEventListener('keyup', (e) => { 
      if(e.code === 'Space') handleEnd(); 
    });
    trigger.addEventListener('pointerdown', (e) => { 
      e.preventDefault(); 
      handleStart(); 
    });
    window.addEventListener('pointerup', handleEnd);

    generateScramble();
    updateUI();
  </script>
</body>
</html>
